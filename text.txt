<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Game Score</title>
  <style>
    :root{ color-scheme: light dark; }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:16px;max-width:900px}
    h1{margin:0 0 12px}
    .card{border:1px solid #e5e5e5;border-radius:16px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,button{padding:10px 12px;border-radius:12px;border:1px solid #cfcfcf;font-size:16px}
    button{cursor:pointer}
    button.primary{font-weight:700}
    .muted{opacity:.75;font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid #eee;text-align:center}
    th:first-child, td:first-child{text-align:left}
    .tag{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #bbb;margin-left:8px}
    .top{background:#B6F2C2;color:#000}
    .low{background:#F6B3B3;color:#000}
    .outRow{background:#2b2b2b}
    .outText{color:#9a9a9a}
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:640px){ .grid2{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <h1>Game Score</h1>

  <div class="card" id="setupCard">
    <div class="row">
      <input id="playerCount" type="number" min="2" max="10" value="2" />
      <button class="primary" id="startBtn">Start / New Game</button>
      <span class="muted">Auto-saves on this device.</span>
    </div>
    <div class="muted">Tip: After you host this, open it in Safari → Share → Add to Home Screen.</div>
  </div>

  <div class="card" id="appCard" style="display:none">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <button class="primary" id="addRoundBtn">ADD ROUND</button>
        <button id="addPlayerBtn">ADD PLAYER</button>
        <button id="editNamesBtn">EDIT NAMES</button>
      </div>
      <div class="row">
        <label class="muted">Kick-out target:</label>
        <input id="targetInput" type="number" min="1" value="100" style="width:110px" />
        <button id="resetBtn">RESET</button>
      </div>
    </div>

    <div class="muted" id="statusLine"></div>

    <div id="tableWrap"></div>
  </div>

<script>
const STORAGE_KEY = "gameScore_v1";

let state = null;

function save() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

function load() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return null;
    const s = JSON.parse(raw);
    if (!s || !Array.isArray(s.players)) return null;
    return s;
  } catch { return null; }
}

function newGame(n) {
  state = {
    target: 100,
    players: Array.from({length:n}, (_,i)=>({
      name: `Player ${i+1}`,
      total: 0,
      out: false
    }))
  };
  save();
}

function inPlayers() {
  return state.players.filter(p => !p.out);
}

function computeTopLowIndex() {
  const ins = state.players.map((p, i)=>({p,i})).filter(x=>!x.p.out);
  if (ins.length === 0) return {top:-1, low:-1, allEqual:true};

  let top = ins[0].i, low = ins[0].i;
  for (const x of ins) {
    if (state.players[x.i].total > state.players[top].total) top = x.i;
    if (state.players[x.i].total < state.players[low].total) low = x.i;
  }
  const allEqual = ins.every(x => state.players[x.i].total === state.players[ins[0].i].total);
  return {top, low, allEqual};
}

function render() {
  document.getElementById("appCard").style.display = state ? "" : "none";

  if (!state) return;

  // target sync
  document.getElementById("targetInput").value = state.target;

  const {top, low, allEqual} = computeTopLowIndex();
  const outCount = state.players.filter(p=>p.out).length;
  const inCount = state.players.length - outCount;

  document.getElementById("statusLine").textContent =
    `Players: ${state.players.length} (IN: ${inCount}, OUT: ${outCount}) • OUT when total ≥ ${state.target}.`;

  let html = `<table>
    <thead>
      <tr><th>Player</th><th>Total</th><th>Status</th></tr>
    </thead><tbody>`;

  state.players.forEach((p, i) => {
    const isTop = !allEqual && i === top;
    const isLow = !allEqual && i === low;
    const rowClass = p.out ? "outRow" : (isTop ? "top" : (isLow ? "low" : ""));
    const textClass = p.out ? "outText" : "";

    let badge = "";
    if (!p.out && isTop) badge = `<span class="tag">TOP</span>`;
    if (!p.out && isLow) badge = `<span class="tag">LOW</span>`;
    if (p.out) badge = `<span class="tag">OUT</span>`;

    html += `<tr class="${rowClass}">
      <td class="${textClass}"><b>${escapeHtml(p.name)}</b> ${badge}</td>
      <td class="${textClass}">${p.total}</td>
      <td class="${textClass}">${p.out ? "OUT (skipped)" : "IN"}</td>
    </tr>`;
  });

  html += `</tbody></table>`;
  document.getElementById("tableWrap").innerHTML = html;
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

async function promptNames(players) {
  // Simple sequential prompts (works everywhere)
  for (let i = 0; i < players.length; i++) {
    const name = prompt(`Name for Player ${i+1}:`, players[i].name);
    if (name === null) return false; // cancel
    players[i].name = name.trim() || players[i].name;
  }
  return true;
}

function applyKickouts() {
  for (const p of state.players) {
    if (!p.out && p.total >= state.target) p.out = true;
  }
}

document.getElementById("startBtn").addEventListener("click", async () => {
  const n = Number(document.getElementById("playerCount").value);
  if (!(n >= 2 && n <= 10)) return alert("Players must be between 2 and 10.");
  newGame(n);
  // name them
  const ok = await promptNames(state.players);
  if (!ok) return;
  save();
  render();
});

document.getElementById("addRoundBtn").addEventListener("click", () => {
  const ins = state.players.map((p,i)=>({p,i})).filter(x=>!x.p.out);
  if (ins.length === 0) return alert("Everyone is OUT. Reset or start a new game.");

  for (const x of ins) {
    const v = prompt(`Points for ${x.p.name}:`, "0");
    if (v === null) return; // cancel whole round
    const pts = Number(v) || 0;
    state.players[x.i].total += pts;
  }

  applyKickouts();
  save();
  render();
});

document.getElementById("addPlayerBtn").addEventListener("click", () => {
  if (state.players.length >= 10) return alert("Max players is 10.");
  const name = prompt("New player name:", `Player ${state.players.length + 1}`);
  if (name === null) return;
  state.players.push({name: name.trim() || `Player ${state.players.length+1}`, total:0, out:false});
  save();
  render();
});

document.getElementById("editNamesBtn").addEventListener("click", async () => {
  const ok = await promptNames(state.players);
  if (!ok) return;
  save();
  render();
});

document.getElementById("targetInput").addEventListener("change", () => {
  let t = Math.floor(Number(document.getElementById("targetInput").value));
  if (!Number.isFinite(t) || t < 1) t = 1;
  state.target = t;

  // re-evaluate OUT based on new target
  for (const p of state.players) p.out = (p.total >= state.target);

  save();
  render();
});

document.getElementById("resetBtn").addEventListener("click", () => {
  if (!confirm("Reset totals to 0 and set everyone IN? (Names stay)")) return;
  for (const p of state.players) { p.total = 0; p.out = false; }
  save();
  render();
});

// Boot
state = load();
if (state) {
  document.getElementById("appCard").style.display = "";
  render();
}
</script>
</body>
</html>